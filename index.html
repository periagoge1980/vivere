<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title">Welcome to the Vivere Project</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background-color: #007BFF;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
      text-align: left;
    }
    .container {
      flex: 1;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
      width: 100%;
    }
    .blurb-box {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin: 20px 0;
    }
    nav {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .links {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    .links a {
      margin: 5px 10px;
      text-decoration: none;
      color: white;
      background-color: #007BFF;
      padding: 10px 20px;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }
    .links a:hover {
      background-color: #0056b3;
    }
    .login {
      display: flex;
      align-items: center;
    }
    .login button {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 100%;
      max-width: 200px;
      margin-right: 10px;
    }
    .login button:hover {
      background-color: #0056b3;
    }
    .lang-switch {
      display: flex;
      align-items: center;
    }
    .lang-switch button {
      margin: 0 5px;
      padding: 5px 10px;
      cursor: pointer;
      border: none;
      background-color: #007BFF;
      color: white;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }
    .lang-switch button:hover {
      background-color: #0056b3;
    }
    footer {
      background-color: #f1f1f1;
      padding: 10px;
      text-align: center;
    }
    .message {
      color: red;
      margin-top: 10px;
    }
    .blurb {
      text-align: left;
      font-size: 1rem;
    }
    .blurb p {
      margin-bottom: 10px;
    }
    .note {
      font-size: 0.8rem;
    }
    .patreon {
      text-align: center;
      margin-top: 20px;
    }
    .patreon a {
      display: inline-block;
      padding: 10px 20px;
      background-color: #f96854;
      color: white;
      border-radius: 5px;
      text-decoration: none;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    .patreon a:hover {
      background-color: #c65042;
    }
    .logo {
      margin: 20px auto;
      text-align: center;
    }
    .logo img {
      max-width: 200px;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="header-title">Welcome to the Vivere Project</h1>
    <div class="login">
      <button id="login">Login/Signup</button>
      <div class="lang-switch">
        <button id="lang-en">EN</button>
        <button id="lang-fr">FR</button>
      </div>
    </div>
  </header>
  <div class="container">
    <div class="logo">
      <img src="logo.webp" alt="Vivere Project Logo">
    </div>
    <div class="blurb-box">
      <div class="blurb" id="blurb">
        <p>Welcome to The Vivere Project. Our mission is to provide comprehensive online resources for individuals struggling with various forms of addiction. We understand the challenges and the courage it takes to seek help and make a change.</p>
        <p>The Vivere Project is entirely free to use. We believe that support should be accessible to everyone without financial barriers.</p>
      </div>
    </div>
    <nav>
      <div class="links">
        <a href="index.html" id="nav-home">Home</a>
        <a href="resources.html" id="nav-resources">Resources</a>
        <a href="myplan.html" id="nav-plan">My Plan</a>
        <a href="blog.html" id="nav-blog">Blog</a>
      </div>
    </nav>
    <div id="message" class="message" style="display: none;">Please log in to access this member-only feature.</div>
    <div class="patreon">
      <a href="https://www.patreon.com/thevivereproject" target="_blank" id="patreon-link">Support Us on Patreon</a>
    </div>
  </div>
  <footer>
    &copy; 2024 Projet Vivere. Tous droits réservés.
  </footer>

  <!-- Load the Netlify Identity widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <!-- Load Supabase JS library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <script>
    async function getSupabaseKey() {
      const response = await fetch('/.netlify/functions/getSupabaseKey');
      const data = await response.json();
      return data.key;
    }

    async function initSupabase() {
      const supabaseKey = await getSupabaseKey();
      const supabaseUrl = 'https://ssdnvbiiznvjuobrrhpt.supabase.co';
      return supabase.createClient(supabaseUrl, supabaseKey);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize Netlify Identity
      netlifyIdentity.init();

      const loginButton = document.getElementById('login');
      const myPlanLink = document.getElementById('myPlanLink');
      const message = document.getElementById('message');
      const blurbElement = document.getElementById('blurb');
      const pageTitle = document.getElementById('page-title');
      const headerTitle = document.getElementById('header-title');
      const navHome = document.getElementById('nav-home');
      const navResources = document.getElementById('nav-resources');
      const navPlan = document.getElementById('nav-plan');
      const navBlog = document.getElementById('nav-blog');
      const patreonLink = document.getElementById('patreon-link');

      const translations = {
        en: {
          title: 'Welcome to the Vivere Project',
          header: 'Welcome to the Vivere Project',
          blurb: `
            <p>Welcome to The Vivere Project. Our mission is to provide comprehensive online resources for individuals struggling with various forms of addiction. We understand the challenges and the courage it takes to seek help and make a change.</p>
            <p>The Vivere Project is entirely free to use. We believe that support should be accessible to everyone without financial barriers.</p>
          `,
          nav: {
            home: 'Home',
            resources: 'Resources',
            plan: 'My Plan',
            blog: 'Blog'
          },
          message: 'Please log in to access this member-only feature.',
          patreon: 'Support Us on Patreon'
        },
        fr: {
          title: 'Bienvenue sur Le Projet Vivere',
          header: 'Bienvenue sur Le Projet Vivere',
          blurb: `
            <p>Bienvenue sur Le Projet Vivere. Notre mission est de fournir des ressources en ligne complètes pour les personnes confrontées à divers types de dépendances. Nous comprenons les défis et le courage qu'il faut pour demander de l'aide et changer.</p>
            <p>Le Projet Vivere est entièrement gratuit à utiliser. Nous croyons que le soutien doit être accessible à tous sans barrières financières.</p>       
          `,
          nav: {
            home: 'Accueil',
            resources: 'Ressources',
            plan: 'Mon Plan',
            blog: 'Blogue'
          },
          message: 'Veuillez vous connecter pour accéder à cette```html
          fonctionnalité réservée aux membres.',
          patreon: 'Soutenez-nous sur Patreon'
        }
      };

      const setLanguage = (lang) => {
        if (translations[lang]) {
          blurbElement.innerHTML = translations[lang].blurb;
          pageTitle.textContent = translations[lang].title;
          headerTitle.textContent = translations[lang].header;

          navHome.textContent = translations[lang].nav.home;
          navResources.textContent = translations[lang].nav.resources;
          navPlan.textContent = translations[lang].nav.plan;
          navBlog.textContent = translations[lang].nav.blog;

          message.textContent = translations[lang].message;
          patreonLink.textContent = translations[lang].patreon;
        }
      };

      document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
      document.getElementById('lang-fr').addEventListener('click', () => setLanguage('fr'));

      // Set default language
      setLanguage('fr');

      // Handle Netlify Identity events
      netlifyIdentity.on('init', async (user) => {
        if (user) {
          const supabase = await initSupabase();

          try {
            const { data, error } = await supabase
              .from('users')
              .select('*')
              .eq('user_id', user.id);

            if (error) {
              console.error('Error fetching user data:', error);
              alert('There was an error fetching user data. Check the console for details.');
            } else if (data.length === 0) {
              // Get the username and email from the Netlify Identity user object
              const username = user.user_metadata.full_name || user.email; // Default to email if full_name is not available
              const email = user.email;

              const { error: insertError } = await supabase
                .from('users')
                .insert([{ user_id: user.id, username: username, email: email }]);

              if (insertError) {
                console.error('Error inserting new user:', insertError);
                alert('There was an error inserting new user. Check the console for details.');
              } else {
                console.log('New user created in Supabase');
              }
            } else {
              console.log('User already exists in Supabase');
            }
          } catch (e) {
            console.error('Unexpected error:', e);
            alert('An unexpected error occurred. Check the console for details.');
          }
        }
      });

      netlifyIdentity.on('login', async (user) => {
        console.log('User logged in:', user);
        netlifyIdentity.close();

        const supabase = await initSupabase();

        try {
          const { data, error } = await supabase
            .from('users')
            .select('*')
            .eq('user_id', user.id);

          if (error) {
            console.error('Error fetching user data:', error);
            alert('There was an error fetching user data. Check the console for details.');
          } else if (data.length === 0) {
            const username = user.user_metadata.full_name || user.email; // Default to email if full_name is not available
            const email = user.email;

            const { error: insertError } = await supabase
              .from('users')
              .insert([{ user_id: user.id, username: username, email: email }]);

            if (insertError) {
              console.error('Error inserting new user:', insertError);
              alert('There was an error inserting new user. Check the console for details.');
            } else {
              console.log('New user created in Supabase');
            }
          } else {
            console.log('User already exists in Supabase');
          }
        } catch (e) {
          console.error('Unexpected error:', e);
          alert('An unexpected error occurred. Check the console for details.');
        }
      });

      netlifyIdentity.on('logout', () => {
        console.log('User logged out');
      });

      if (myPlanLink) {
        myPlanLink.addEventListener('click', (e) => {
          const user = netlifyIdentity.currentUser();
          if (!user) {
            e.preventDefault();
            message.style.display = 'block';
            setTimeout(() => {
              message.style.display = 'none';
            }, 3000);
          } else {
            window.location.href = 'myplan.html';
          }
        });
      }

      loginButton.addEventListener('click', () => {
        netlifyIdentity.open();
      });

      // Example: Call to fetch users using the Netlify Function proxy
      async function fetchUsers() {
        try {
          const response = await fetch('/.netlify/functions/supabaseProxy');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log(data);
        } catch (error) {
          console.error('Error fetching users:', error);
          alert('There was an error fetching users. Check the console for details.');
        }
      }

      // Fetch users when the page loads
      fetchUsers();
    });
  </script>
</body>
</html>
