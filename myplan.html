<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mon Plan</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background-color: #007BFF;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
      text-align: left;
      font-weight: bold;
      color: white;
    }
    .login {
      display: flex;
      align-items: center;
    }
    .login button {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-right: 10px;
    }
    .login button:hover {
      background-color: #0056b3;
    }
    .lang-switch {
      display: flex;
      align-items: center;
    }
    .lang-switch button {
      margin: 0 5px;
      padding: 5px 10px;
      cursor: pointer;
      border: none;
      background-color: #007BFF;
      color: white;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }
    .lang-switch button:hover {
      background-color: #0056b3;
    }
    .container {
      flex: 1;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }
    .links {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    .links a {
      margin: 5px 10px;
      text-decoration: none;
      color: white;
      background-color: #007BFF;
      padding: 10px 20px;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }
    .links a:hover {
      background-color: #0056b3;
    }
    form {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }
    input[type="date"] {
      padding: 10px;
      margin-left: 10px;
      font-size: 16px;
    }
    h3 {
      margin: 0 10px 0 0;
      font-size: 1rem;
      color: #333;
    }
    button {
      padding: 10px;
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #0056b3;
    }
    #timeCounter {
      text-align: center;
      margin: 20px 0;
      font-size: 20px;
      color: #333;
    }
    #calendar {
      max-width: 900px;
      margin: 0 auto;
      margin-top: 20px;
    }
    footer {
      background-color: #f1f1f1;
      padding: 10px;
      text-align: center;
      margin-top: auto;
    }
    .login-link {
      color: white;
      cursor: pointer;
      text-decoration: none;
      font-weight: bold;
    }
    #note-popup, #note-input-popup, #journal-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      border: 1px solid #ccc;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
    #note-popup button, #note-input-popup button, #journal-popup button {
      margin: 5px;
      padding: 10px 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      border-radius: 5px;
    }
    #note-popup button:hover, #note-input-popup button:hover, #journal-popup button:hover {
      background-color: #0056b3;
    }
    #note-popup-overlay, #note-input-popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    .note-block {
      margin: 5px 0;
      padding: 10px;
      border-radius: 5px;
    }
    .patreon {
      text-align: center;
      margin-top: 20px;
    }
    .patreon a {
      display: inline-block;
      padding: 10px 20px;
      background-color: #f96854;
      color: white;
      border-radius: 5px;
      text-decoration: none;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    .patreon a:hover {
      background-color: #c65042;
    }
    #restricted-message {
      display: none;
      text-align: center;
      color: red;
      font-size: 1.2rem;
      margin-top: 50px;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="header-title">Bienvenue sur Le Projet Vivere</h1>
    <div class="login">
      <button id="login">Connexion/Inscription</button>
      <div class="lang-switch">
        <button id="lang-en">EN</button>
        <button id="lang-fr">FR</button>
      </div>
    </div>
  </header>

  <div id="restricted-message">Access to this page is restricted to members. Please log in to continue.</div>

  <div class="container" id="main-content" style="display: none;">
    <div class="links">
      <a href="index.html">Accueil</a>
      <a href="resources.html">Ressources</a>
      <a href="myplan.html">Mon Plan</a>
    </div>

    <h1 id="page-title">Mon Plan</h1>

    <form id="dateForm">
      <h3 id="select-date-title">Sélectionnez une date d'arrêt</h3>
      <input type="date" id="startDate" value="">
      <button type="submit" id="commit-button">C'est Fini!</button>
    </form>
    <div id="timeCounter">Temps écoulé depuis l'engagement: 00:00:00</div>
    <div id="calendar"></div>

    <div class="patreon">
      <a href="https://www.patreon.com/thevivereproject" target="_blank">Soutenez-nous sur Patreon</a>
    </div>
  </div>
  <footer>
    &copy; 2024 Projet Vivere. Tous droits réservés.
  </footer>

  <div id="note-popup-overlay"></div>
  <div id="note-popup">
    <p>How was that day?</p>
    <button id="positive">Positive</button>
    <button id="triggered">Triggered</button>
    <button id="relapsed">Relapsed</button>
    <button id="add-note">Add a Note</button>
    <button id="view-day">View Day</button>
    <button id="remove-note" style="display: none;">Remove Note</button>
    <div id="notes-container"></div>
  </div>

  <div id="note-input-popup">
    <p>Add your custom note:</p>
    <textarea id="custom-note" rows="4" cols="50"></textarea>
    <button id="save-note">Save Note</button>
    <button id="cancel-note">Cancel</button>
  </div>

  <div id="journal-popup">
    <p>Journal Entries</p>
    <div id="day-journal"></div>
    <button id="close-journal">Close</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <script>
    let timerInterval;

    async function getSupabaseKey() {
      const response = await fetch('/.netlify/functions/getSupabaseKey');
      const data = await response.json();
      return data.key;
    }

    async function initSupabase() {
      const supabaseKey = await getSupabaseKey();
      const supabaseUrl = 'https://ssdnvbiiznvjuobrrhpt.supabase.co';
      return supabase.createClient(supabaseUrl, supabaseKey);
    }

    $(document).ready(function() {
      netlifyIdentity.on('init', async (user) => {
        if (user) {
          $('#main-content').show();
        } else {
          netlifyIdentity.open();

          // Fallback to showing a message if the login pop-up does not appear
          setTimeout(() => {
            if (!netlifyIdentity.currentUser()) {
              $('#restricted-message').show();
            }
          }, 3000); // Adjust the timeout as needed
        }
      });

      const storedNotes = JSON.parse(localStorage.getItem('notes')) || {};
      const storedCommitTime = localStorage.getItem('commitTime');

      const translations = {
        en: {
          title: 'My Plan',
          header: 'Welcome to the Vivere Project',
          commitButton: 'Commit!',
          timeSinceCommit: 'Time since commit:',
          planTitle: 'My Plan',
          selectDate: 'Select a quit date',
        },
        fr: {
          title: 'Mon Plan',
          header: 'Bienvenue sur Le Projet Vivere',
          commitButton: "C'est Fini!",
          timeSinceCommit: "Temps écoulé depuis l'engagement:",
          planTitle: 'Mon Plan',
          selectDate: "Sélectionnez une date d'arrêt",
        }
      };

      function setLanguage(lang) {
        if (translations[lang]) {
          document.title = translations[lang].title;
          document.getElementById('header-title').textContent = translations[lang].header;
          document.getElementById('commit-button').textContent = translations[lang].commitButton;
          document.getElementById('timeCounter').textContent = translations[lang].timeSinceCommit + ' 00:00:00';
          document.getElementById('page-title').textContent = translations[lang].planTitle;
          document.getElementById('select-date-title').textContent = translations[lang].selectDate;
        }
      }

      document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
      document.getElementById('lang-fr').addEventListener('click', () => setLanguage('fr'));

      $('#dateForm').on('submit', async function(e) {
        e.preventDefault();
        const selectedDate = $('#startDate').val();
        if (selectedDate) {
          const commitTime = new Date();
          const selectedDateArray = selectedDate.split('-');
          commitTime.setFullYear(
            selectedDateArray[0],
            selectedDateArray[1] - 1,
            selectedDateArray[2]
          );
          localStorage.setItem('commitTime', commitTime.toISOString());
          displayCalendar(selectedDate);
          startTimer(commitTime);

          const user = netlifyIdentity.currentUser();
          if (user) {
            try {
              const supabase = await initSupabase();
              const { data, error } = await supabase
                .from('commit_times')
                .insert([{ user_id: user.id, commit_time: commitTime.toISOString() }]);

              if (error) {
                console.error('Error inserting commit time:', error);
                alert('There was an error saving your commitment time. Check the console for details.');
              } else {
                console.log('Commit time saved in Supabase');
              }
            } catch (e) {
              console.error('Unexpected error:', e);
              alert('An unexpected error occurred while saving your commit time. Check the console for details.');
            }
          }
        }
      });

      if (storedCommitTime) {
        const commitTime = new Date(storedCommitTime);
        $('#startDate').val(moment(commitTime).format('YYYY-MM-DD'));
        displayCalendar(moment(commitTime).format('YYYY-MM-DD'));
        startTimer(commitTime);
      } else {
        displayCalendar(new Date());
      }

      function displayCalendar(date) {
        $('#calendar').fullCalendar('destroy');
        $('#calendar').fullCalendar({
          defaultDate: date,
          editable: true,
          eventLimit: true,
          dayClick: function(date) {
            const selectedDate = date.format('YYYY-MM-DD');
            $('#note-popup').data('date', selectedDate).show();
            displayNotes(selectedDate);
          },
          events: getStoredEvents()
        });
      }

      function getStoredEvents() {
        let events = [];
        for (let date in storedNotes) {
          storedNotes[date].forEach(note => {
            events.push({
              title: note.title,
              start: date
            });
          });
        }
        return events;
      }

      function displayNotes(date) {
        const notesContainer = $('#notes-container');
        notesContainer.empty();
        if (storedNotes[date]) {
          storedNotes[date].forEach(note => {
            const noteBlock = `<div class="note-block">${note.note}</div>`;
            notesContainer.append(noteBlock);
          });
          $('#remove-note').show();
        } else {
          notesContainer.append('<div class="note-block">No notes for this day.</div>');
          $('#remove-note').hide();
        }
      }

      $('#positive').click(() => saveNoteToCalendar('Positive'));
      $('#triggered').click(() => saveNoteToCalendar('Triggered'));
      $('#relapsed').click(() => {
        saveNoteToCalendar('Relapsed');
        resetTimer();
      });
      $('#add-note').click(() => {
        $('#note-popup').hide();
        $('#note-input-popup').show();
      });
      $('#remove-note').click(() => removeNoteFromCalendar());
      $('#view-day').click(() => viewDayJournal());

      $('#save-note').click(() => {
        const selectedDate = $('#note-popup').data('date');
        const customNote = $('#custom-note').val();
        if (customNote) {
          addNoteToDate(selectedDate, {
            title: customNote,
            note: customNote
          });
          $('#custom-note').val('');
          $('#note-input-popup').hide();
          displayCalendar($('#startDate').val());
        }
      });

      $('#cancel-note').click(() => {
        $('#note-input-popup').hide();
      });

      async function saveNoteToCalendar(note) {
        const selectedDate = $('#note-popup').data('date');
        addNoteToDate(selectedDate, {
          title: note,
          note: note
        });
        $('#note-popup').hide();
        displayCalendar($('#startDate').val());

        const user = netlifyIdentity.currentUser();
        if (user) {
          try {
            const supabase = await initSupabase();
            const { data, error } = await supabase
              .from('notes')
              .insert([{ user_id: user.id, note_date: selectedDate, note_title: note }]);

            if (error) {
              console.error('Error saving note:', error);
              alert('There was an error saving your note. Check the console for details.');
            } else {
              console.log('Note saved in Supabase');
            }
          } catch (e) {
            console.error('Unexpected error:', e);
            alert('An unexpected error occurred while saving your note. Check the console for details.');
          }
        }
      }

      function addNoteToDate(date, note) {
        if (!storedNotes[date]) {
          storedNotes[date] = [];
        }
        storedNotes[date].push(note);
        localStorage.setItem('notes', JSON.stringify(storedNotes));
      }

      function removeNoteFromCalendar() {
        const selectedDate = $('#note-popup').data('date');
        delete storedNotes[selectedDate];
        localStorage.setItem('notes', JSON.stringify(storedNotes));
        $('#note-popup').hide();
        displayCalendar($('#startDate').val());
      }

      function viewDayJournal() {
        const selectedDate = $('#note-popup').data('date');
        const journalEntries = storedNotes[selectedDate]
          ? storedNotes[selectedDate].map(note => `<div class="note-block">${note.note}</div>`).join('')
          : '<div class="note-block">No notes for this day.</div>';
        $('#day-journal').html(journalEntries);
        $('#note-popup').hide();
        $('#journal-popup').show();
      }

      $('#close-journal').click(() => {
        $('#journal-popup').hide();
      });

      $('#popup-overlay, #note-popup-overlay').on('click', () => {
        $('#note-popup').hide();
        $('#journal-popup').hide();
        $('#note-input-popup').hide();
      });

      function startTimer(commitTime) {
        clearInterval(timerInterval);

        timerInterval = setInterval(function() {
          const currentTime = new Date();
          const timeDiff = currentTime - new Date(commitTime);
          const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
          const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
          $('#timeCounter').text(`${translations[document.documentElement.lang].timeSinceCommit} ${days}j ${formatTime(hours)}:${formatTime(minutes)}:${formatTime(seconds)}`);
        }, 1000);
      }

      function resetTimer() {
        clearInterval(timerInterval);
        const newCommitTime = new Date();
        localStorage.setItem('commitTime', newCommitTime.toISOString());
        startTimer(newCommitTime);
      }

      function formatTime(unit) {
        return unit < 10 ? '0' + unit : unit;
      }

      const loginButton = document.getElementById('login');
      loginButton.addEventListener('click', () => {
        netlifyIdentity.open();
      });

      netlifyIdentity.on('login', async (user) => {
        console.log('User logged in:', user);
        $('#main-content').show();
        $('#restricted-message').hide();
        netlifyIdentity.close();

        try {
          const supabase = await initSupabase();

          const { data: userData, error: userError } = await supabase
            .from('users')
            .select('*')
            .eq('user_id', user.id);

          if (userError) {
            console.error('Error fetching user data:', userError);
            alert('There was an error fetching user data. Check the console for details.');
          } else if (userData.length === 0) {
            const { error: insertError } = await supabase
              .from('users')
              .insert([{ user_id: user.id, email: user.email }]);

            if (insertError) {
              console.error('Error inserting new user:', insertError);
              alert('There was an error inserting new user. Check the console for details.');
            } else {
              console.log('New user created in Supabase');
            }
          } else {
            console.log('User already exists in Supabase');
          }

          const storedCommitTime = localStorage.getItem('commitTime');
          if (storedCommitTime) {
            const { data: commitData, error: commitError } = await supabase
              .from('commit_times')
              .select('*')
              .eq('user_id', user.id);

            if (commitError) {
              console.error('Error fetching commit time data:', commitError);
            } else if (commitData.length === 0) {
              const { error: insertCommitError } = await supabase
                .from('commit_times')
                .insert([{ user_id: user.id, commit_time: storedCommitTime }]);

              if (insertCommitError) {
                console.error('Error inserting commit time:', insertCommitError);
              } else {
                console.log('Commit time synced to Supabase');
              }
            }
          }

          const storedNotes = JSON.parse(localStorage.getItem('notes')) || {};
          for (let date in storedNotes) {
            for (let note of storedNotes[date]) {
              const { data: noteData, error: noteError } = await supabase
                .from('notes')
                .select('*')
                .eq('user_id', user.id)
                .eq('note_date', date)
                .eq('note_title', note.title);

              if (noteError) {
                console.error('Error fetching note data:', noteError);
              } else if (noteData.length === 0) {
                const { error: insertNoteError } = await supabase
                  .from('notes')
                  .insert([{ user_id: user.id, note_date: date, note_title: note.title }]);

                if (insertNoteError) {
                  console.error('Error inserting note:', insertNoteError);
                } else {
                  console.log('Note synced to Supabase');
                }
              }
            }
          }

        } catch (e) {
          console.error('Unexpected error:', e);
          alert('An unexpected error occurred. Check the console for details.');
        }
      });

      netlifyIdentity.on('logout', () => {
        console.log('User logged out');
        window.location.href = 'index.html';
      });

      const commitTime = localStorage.getItem('commitTime');
      if (commitTime) {
        displayCalendar(moment(commitTime).format('YYYY-MM-DD'));
        startTimer(new Date(commitTime));
      } else {
        displayCalendar(new Date());
      }

      setLanguage('fr');
    });
  </script>
</body>
</html>
