<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mon Plan</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" rel="stylesheet">
  <style>
    /* Your existing CSS styles */
  </style>
</head>
<body>
  <header>
    <h1 id="header-title">Bienvenue sur Le Projet Vivere</h1>
    <div class="login">
      <button id="login">Connexion/Inscription</button>
      <div class="lang-switch">
        <button id="lang-en">EN</button>
        <button id="lang-fr">FR</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="links">
      <a id="home-link" href="index.html">Accueil</a>
      <a id="resources-link" href="resources.html">Ressources</a>
      <a id="plan-link" href="myplan.html">Mon Plan</a>
    </div>

    <h1 id="page-title">Mon Plan</h1>

    <form id="dateForm">
      <h3 id="select-date-title">Sélectionnez une date d'arrêt</h3>
      <input type="date" id="startDate" value="">
      <button type="submit" id="commit-button">C'est Fini!</button>
    </form>
    <div id="timeCounter">Temps écoulé depuis l'engagement: 00:00:00</div>
    <div id="calendar"></div>

    <!-- Patreon Button -->
    <div class="patreon">
      <a href="https://www.patreon.com/thevivereproject" target="_blank">Soutenez-nous sur Patreon</a>
    </div>
  </div>
  <footer>
    &copy; 2024 Projet Vivere. Tous droits réservés.
  </footer>

  <div id="note-popup-overlay"></div>
  <div id="note-popup">
    <p id="note-popup-title">How was that day?</p>
    <button id="positive">Positive</button>
    <button id="triggered">Triggered</button>
    <button id="relapsed">Relapsed</button>
    <button id="add-note">Add a Note</button>
    <button id="view-day">View Day</button>
    <button id="remove-note" style="display: none;">Remove Note</button>
    <div id="notes-container"></div>
  </div>

  <div id="note-input-popup">
    <p id="note-input-popup-title">Add your custom note:</p>
    <textarea id="custom-note" rows="4" cols="50"></textarea>
    <button id="save-note">Save Note</button>
    <button id="cancel-note">Cancel</button>
  </div>

  <div id="journal-popup">
    <p id="journal-popup-title">Journal Entries</p>
    <div id="day-journal"></div>
    <button id="close-journal">Close</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <script>
    let timerInterval;

    async function getSupabaseKey() {
      const response = await fetch('/.netlify/functions/getSupabaseKey');
      const data = await response.json();
      return data.key;
    }

    async function initSupabase() {
      const supabaseKey = await getSupabaseKey();
      const supabaseUrl = 'https://ssdnvbiiznvjuobrrhpt.supabase.co';
      return supabase.createClient(supabaseUrl, supabaseKey);
    }

    async function ensureLoggedIn() {
      return new Promise((resolve, reject) => {
        netlifyIdentity.on('init', user => {
          if (!user) {
            netlifyIdentity.open();
            netlifyIdentity.on('login', () => resolve(true));
            netlifyIdentity.on('close', () => reject(new Error('User not logged in')));
          } else {
            resolve(true);
          }
        });
      });
    }

    $(document).ready(async function() {
      try {
        await ensureLoggedIn();
      } catch (error) {
        alert('Please log in to access this member-only feature.');
        return;
      }

      const storedNotes = JSON.parse(localStorage.getItem('notes')) || {};
      const storedCommitTime = localStorage.getItem('commitTime');

      const translations = {
        en: {
          title: 'My Plan',
          header: 'Welcome to the Vivere Project',
          commitButton: 'Commit!',
          timeSinceCommit: 'Time since commit:',
          planTitle: 'My Plan',
          selectDate: 'Select a quit date',
          homeLink: 'Home',
          resourcesLink: 'Resources',
          planLink: 'My Plan',
          notePopupTitle: 'How was that day?',
          noteInputPopupTitle: 'Add your custom note:',
          journalPopupTitle: 'Journal Entries',
          saveNoteButton: 'Save Note',
          cancelNoteButton: 'Cancel',
          closeJournalButton: 'Close',
        },
        fr: {
          title: 'Mon Plan',
          header: 'Bienvenue sur Le Projet Vivere',
          commitButton: "C'est Fini!",
          timeSinceCommit: "Temps écoulé depuis l'engagement:",
          planTitle: 'Mon Plan',
          selectDate: "Sélectionnez une date d'arrêt",
          homeLink: 'Accueil',
          resourcesLink: 'Ressources',
          planLink: 'Mon Plan',
          notePopupTitle: 'Comment s\'est passée la journée?',
          noteInputPopupTitle: 'Ajoutez votre note personnalisée :',
          journalPopupTitle: 'Entrées du Journal',
          saveNoteButton: 'Enregistrer la note',
          cancelNoteButton: 'Annuler',
          closeJournalButton: 'Fermer',
        }
      };

      function setLanguage(lang) {
        if (translations[lang]) {
          localStorage.setItem('language', lang);
          document.title = translations[lang].title;
          document.getElementById('header-title').textContent = translations[lang].header;
          document.getElementById('commit-button').textContent = translations[lang].commitButton;
          document.getElementById('timeCounter').textContent = translations[lang].timeSinceCommit + ' 00:00:00';
          document.getElementById('page-title').textContent = translations[lang].planTitle;
          document.getElementById('select-date-title').textContent = translations[lang].selectDate;
          document.getElementById('home-link').textContent = translations[lang].homeLink;
          document.getElementById('resources-link').textContent = translations[lang].resourcesLink;
          document.getElementById('plan-link').textContent = translations[lang].planLink;
          document.getElementById('note-popup-title').textContent = translations[lang].notePopupTitle;
          document.getElementById('note-input-popup-title').textContent = translations[lang].noteInputPopupTitle;
          document.getElementById('journal-popup-title').textContent = translations[lang].journalPopupTitle;
          document.getElementById('save-note').textContent = translations[lang].saveNoteButton;
          document.getElementById('cancel-note').textContent = translations[lang].cancelNoteButton;
          document.getElementById('close-journal').textContent = translations[lang].closeJournalButton;
        }
      }

      document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
      document.getElementById('lang-fr').addEventListener('click', () => setLanguage('fr'));

      // Trigger language setting on page load
      setLanguage(localStorage.getItem('language') || 'fr');

      // Handle commit time form submission
      $('#dateForm').on('submit', async function(e) {
        e.preventDefault();
        const selectedDate = $('#startDate').val();
        if (selectedDate) {
          const commitTime = new Date(); // Capture the exact time of commit
          const selectedDateArray = selectedDate.split('-');
          commitTime.setFullYear(
            selectedDateArray[0],
            selectedDateArray[1] - 1,
            selectedDateArray[2]
          );
          localStorage.setItem('commitTime', commitTime.toISOString());
          displayCalendar(selectedDate);
          startTimer(commitTime);

          // Save commit time to Supabase
          const user = netlifyIdentity.currentUser();
          if (user) {
            try {
              const supabase = await initSupabase();
              const { data, error } = await supabase
                .from('commit_times')
                .insert([{ user_id: user.id, commit_time: commitTime.toISOString() }]);

              if (error) {
                console.error('Error inserting commit time:', error);
                alert('There was an error saving your commitment time. Check the console for details.');
              } else {
                console.log('Commit time saved in Supabase');
              }
            } catch (e) {
              console.error('Unexpected error:', e);
              alert('An unexpected error occurred while saving your commit time. Check the console for details.');
            }
          }
        }
      });

      // Initialize the calendar and timer if commit time exists
      if (storedCommitTime) {
        const commitTime = new Date(storedCommitTime);
        $('#startDate').val(moment(commitTime).format('YYYY-MM-DD'));
        displayCalendar(moment(commitTime).format('YYYY-MM-DD'));
        startTimer(commitTime);
      } else {
        displayCalendar(new Date());
      }

      function displayCalendar(date) {
        $('#calendar').fullCalendar('destroy'); // Destroy any existing calendar
        $('#calendar').fullCalendar({
          defaultDate: date,
          editable: true,
          eventLimit: true, // allow "more" link when too many events
          dayClick: function(date) {
            const selectedDate = date.format('YYYY-MM-DD');
            $('#note-popup').data('date', selectedDate).show();
            displayNotes(selectedDate);
          },
          events: getStoredEvents()
        });
      }

      function getStoredEvents() {
        let events = [];
        for (let date in storedNotes) {
          storedNotes[date].forEach(note => {
            events.push({
              title: note.title,
              start: date
            });
          });
        }
        return events;
      }

      function displayNotes(date) {
        const notesContainer = $('#notes-container');
        notesContainer.empty(); // Clear any previous notes
        if (storedNotes[date]) {
          storedNotes[date].forEach(note => {
            const noteBlock = `<div class="note-block">${note.note}</div>`;
            notesContainer.append(noteBlock);
          });
          $('#remove-note').show();
        } else {
          notesContainer.append('<div class="note-block">No notes for this day.</div>');
          $('#remove-note').hide();
        }
      }

      $('#positive').click(() => saveNoteToCalendar('Positive'));
      $('#triggered').click(() => saveNoteToCalendar('Triggered'));
      $('#relapsed').click(() => {
        saveNoteToCalendar('Relapsed');
        resetTimer();
      });
      $('#add-note').click(() => {
        $('#note-popup').hide();
        $('#note-input-popup').show();
      });
      $('#remove-note').click(() => removeNoteFromCalendar());
      $('#view-day').click(() => viewDayJournal());

      $('#save-note').click(() => {
        const selectedDate = $('#note-popup').data('date');
        const customNote = $('#custom-note').val();
        if (customNote) {
          addNoteToDate(selectedDate, {
            title: customNote,
            note: customNote
          });
          $('#custom-note').val(''); // Clear the input
          $('#note-input-popup').hide();
          displayCalendar($('#startDate').val());
        }
      });

      $('#cancel-note').click(() => {
        $('#note-input-popup').hide();
      });

      async function saveNoteToCalendar(note) {
        const selectedDate = $('#note-popup').data('date');
        addNoteToDate(selectedDate, {
          title: note,
          note: note
        });
        $('#note-popup').hide();
        displayCalendar($('#startDate').val());

        // Save note to Supabase
        const user = netlifyIdentity.currentUser();
        if (user) {
          try {
            const supabase = await initSupabase();
            const { data, error } = await supabase
              .from('notes')
              .insert([{ user_id: user.id, note_date: selectedDate, note_title: note }]);

            if (error) {
              console.error('Error saving note:', error);
              alert('There was an error saving your note. Check the console for details.');
            } else {
              console.log('Note saved in Supabase');
            }
          } catch (e) {
            console.error('Unexpected error:', e);
            alert('An unexpected error occurred while saving your note. Check the console for details.');
          }
        }
      }

      function addNoteToDate(date, note) {
        if (!storedNotes[date]) {
          storedNotes[date] = [];
        }
        storedNotes[date].push(note);
        localStorage.setItem('notes', JSON.stringify(storedNotes));
      }

      function removeNoteFromCalendar() {
        const selectedDate = $('#note-popup').data('date');
        delete storedNotes[selectedDate];
        localStorage.setItem('notes', JSON.stringify(storedNotes));
        $('#note-popup').hide();
        displayCalendar($('#startDate').val());
      }

      function viewDayJournal() {
        const selectedDate = $('#note-popup').data('date');
        const journalEntries = storedNotes[selectedDate]
          ? storedNotes[selectedDate].map(note => `<div class="note-block">${note.note}</div>`).join('')
          : '<div class="note-block">No notes for this day.</div>';
        $('#day-journal').html(journalEntries);
        $('#note-popup').hide();
        $('#journal-popup').show();
      }

      $('#close-journal').click(() => {
        $('#journal-popup').hide();
      });

      $('#popup-overlay, #note-popup-overlay').on('click', () => {
        $('#note-popup').hide();
        $('#journal-popup').hide();
        $('#note-input-popup').hide();
      });

      function startTimer(commitTime) {
        clearInterval(timerInterval); // Clear any existing timer

        timerInterval = setInterval(function() {
          const currentTime = new Date();
          const timeDiff = currentTime - new Date(commitTime);
          const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
          const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
          $('#timeCounter').text(`${translations[localStorage.getItem('language') || document.documentElement.lang].timeSinceCommit} ${days}j ${formatTime(hours)}:${formatTime(minutes)}:${formatTime(seconds)}`);
        }, 1000);
      }

      function resetTimer() {
        clearInterval(timerInterval);
        const newCommitTime = new Date();
        localStorage.setItem('commitTime', newCommitTime.toISOString());
        startTimer(newCommitTime);
      }

      function formatTime(unit) {
        return unit < 10 ? '0' + unit : unit;
      }

      const loginButton = document.getElementById('login');
      loginButton.addEventListener('click', () => {
        netlifyIdentity.open();
      });

      netlifyIdentity.on('logout', () => {
        console.log('User logged out');
        window.location.href = 'index.html';
      });

    });
  </script>
</body>
</html>
